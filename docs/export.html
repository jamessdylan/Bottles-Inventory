<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wine Export</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;
  padding:24px;
}
.logo{text-align:center;margin-bottom:12px;}
.logo img{max-width:260px;}
.title{
  background:#1f5e3b;
  color:white;
  padding:14px;
  text-align:center;
  border-radius:8px;
  margin-bottom:24px;
}
h2{margin-top:32px;border-bottom:2px solid #1f5e3b;}
h3{margin-top:16px;color:#555;}
table{width:100%;border-collapse:collapse;margin-bottom:12px;}
th,td{padding:8px;border-bottom:1px solid #ddd;}
.qty{text-align:center;font-weight:bold;}
.money{text-align:right;}
.subtotal{font-weight:bold;background:#fafafa;}
</style>
</head>

<body>

<div class="logo">
  <img src="SiennaTransparent.png">
</div>

<div class="title">Wine Inventory Export</div>

<div id="content"></div>

<script>
/* ================= HELPERS ================= */

function wineTitle(item){
  return [item.brand, item.identifier, item.varietal, item.year]
    .filter(v => v && v !== "N/A")
    .join(" ");
}

/* ================= LOAD ITEMS ================= */

const items = JSON.parse(
  localStorage.getItem("exportItems") || "[]"
);

const content = document.getElementById("content");

if (!items.length) {
  content.innerHTML = "<p>No items received.</p>";
  throw new Error("No exportItems found in localStorage");
}

/* ================= GROUP ITEMS ================= */

const tiers = {};
const inactive = [];

items.forEach(item => {
  if (item.status === false) {
    inactive.push(item);
    return;
  }

  const tier = item.tier || "House";
  const color = item.color || "Other";

  if (!tiers[tier]) tiers[tier] = {};
  if (!tiers[tier][color]) tiers[tier][color] = [];

  tiers[tier][color].push({
    qty: Number(item.qty || 0),
    price: Number(item.price || 0),
    ...item
  });
});

/* ================= RENDER ================= */

let grandTotal = 0;

["House","Reserve"].forEach(tier => {
  if (!tiers[tier]) return;

  let tierTotal = 0;

  const h2 = document.createElement("h2");
  h2.textContent = `${tier} Wines`;
  content.appendChild(h2);

  Object.keys(tiers[tier]).forEach(color => {
    const h3 = document.createElement("h3");
    h3.textContent = color;
    content.appendChild(h3);

    const table = document.createElement("table");
    table.innerHTML = `
      <tr>
        <th>Qty</th>
        <th>Wine</th>
        <th class="money">Price</th>
        <th class="money">Total</th>
      </tr>
    `;

    tiers[tier][color].forEach(item => {
      const value = item.qty * item.price;
      tierTotal += value;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="qty">${item.qty}</td>
        <td>${wineTitle(item)}</td>
        <td class="money">$${item.price.toFixed(2)}</td>
        <td class="money">$${value.toFixed(2)}</td>
      `;
      table.appendChild(row);
    });

    content.appendChild(table);
  });

  grandTotal += tierTotal;

  const subtotal = document.createElement("table");
  subtotal.innerHTML = `
    <tr class="subtotal">
      <td colspan="3">${tier} Subtotal</td>
      <td class="money">$${tierTotal.toFixed(2)}</td>
    </tr>
  `;
  content.appendChild(subtotal);
});

/* ================= INACTIVE ================= */

if (inactive.length) {
  const h2 = document.createElement("h2");
  h2.textContent = "Inactive Wines";
  content.appendChild(h2);

  const ul = document.createElement("ul");
  inactive.forEach(i => {
    const li = document.createElement("li");
    li.textContent = wineTitle(i);
    ul.appendChild(li);
  });
  content.appendChild(ul);
}

/* ================= GRAND TOTAL ================= */

const total = document.createElement("h2");
total.style.textAlign = "right";
total.textContent = `Grand Total: $${grandTotal.toFixed(2)}`;
content.appendChild(total);
</script>

</body>
</html>
