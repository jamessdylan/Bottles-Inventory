<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Archive New</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;
  background:#f5f5f5;
}

header{
  padding:20px;
  text-align:center;
  font-family:"Copperplate",serif;
  font-size:20px;
}

.list{
  padding:12px 16px 100px;
}

.row{
  display:flex;
  align-items:center;
  gap:12px;
  padding:14px 16px;
  background:white;
  border-radius:14px;
  margin-bottom:10px;
}

.title{
  flex:1;
  font-size:14px;
}

/* ---------- ACTION TAB ---------- */
.tab{
  min-width:120px;
  text-align:center;
  padding:8px 10px;
  border-radius:999px;
  font-size:13px;
  cursor:pointer;
  user-select:none;
  background:#e0e0e0;
  color:#555;
}

.tab.none{
  background:#e0e0e0;
  color:#777;
}

.tab.active{
  background:#1f5e3b;
  color:white;
}

.tab.inactive{
  background:#848484;
  color:white;
}

.tab.delete{
  background:#7b1e1e;
  color:white;
}

.tab .suggestion{
  color:#888;
  font-style:italic;
}

/* ---------- FOOTER ---------- */
.footer{
  position:fixed;
  left:0; right:0; bottom:0;
  padding:14px 16px;
  background:white;
  border-top:1px solid #ddd;
  display:flex;
  justify-content:space-between;
}

button{
  border:none;
  border-radius:10px;
  padding:12px 18px;
  font-size:16px;
  cursor:pointer;
}

.confirm{
  background:#1f5e3b;
  color:white;
}
</style>
</head>

<body>

<header>Archive Reconciliation</header>

<div class="list" id="list"></div>

<div class="footer">
  <button onclick="window.close()">Cancel</button>
  <button class="confirm" onclick="confirmActions()">Confirm</button>
</div>

<script>
let items = [];
let rows = [];

/* ---------- RECEIVE ITEMS ---------- */
window.addEventListener("message", e => {
  if (!e.data?.items) return;

  items = e.data.items;
  prepareRows();
});

/* ---------- HELPERS ---------- */
function itemTitle(item){
  return [item.brand, item.identifier, item.varietal, item.year]
    .filter(v => v && v !== "N/A")
    .join(" ");
}

/* ---------- PREP ---------- */
function prepareRows(){
  rows = items
    .slice()
    .sort((a,b)=>itemTitle(a).localeCompare(itemTitle(b)))
    .map(item => ({
      item,
      tabValue: "none",
      initialized: false
    }));

  render();
}

/* ---------- TAB CYCLE ---------- */
const TAB_ORDER = ["Make Active","Make Inactive","Delete Item","none"];

function nextTabValue(current){
  const i = TAB_ORDER.indexOf(current);
  return TAB_ORDER[(i + 1) % TAB_ORDER.length];
}

/* ---------- RENDER ---------- */
function render(){
  const list = document.getElementById("list");
  list.innerHTML = "";

  rows.forEach(row => {
    const el = document.createElement("div");
    el.className = "row";

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = itemTitle(row.item);

    const tab = document.createElement("div");
    tab.className = "tab none";

    updateTabUI(tab, row);

    tab.onclick = () => {
      if (!row.initialized){
        row.tabValue = row.item.archivesuggestion;
        row.initialized = true;
      } else {
        row.tabValue = nextTabValue(row.tabValue);
      }
      updateTabUI(tab, row);
    };

    el.appendChild(title);
    el.appendChild(tab);
    list.appendChild(el);
  });
}

function updateTabUI(tab, row){
  tab.className = "tab none";
  tab.textContent = "none";

  if (!row.initialized){
    if (row.item.archivesuggestion && row.item.archivesuggestion !== "none"){
      tab.innerHTML = `<span class="suggestion">${row.item.archivesuggestion}</span>`;
    }
    return;
  }

  tab.textContent = row.tabValue;

  if (row.tabValue === "Make Active") tab.classList.add("active");
  if (row.tabValue === "Make Inactive") tab.classList.add("inactive");
  if (row.tabValue === "Delete Item") tab.classList.add("delete");
}

/* ---------- CONFIRM ---------- */
function confirmActions(){
  // Clone original items so we donâ€™t mutate unexpectedly
  let updatedItems = items.slice();

  rows.forEach(row => {
    const action = row.tabValue;
    const item = row.item;

    if (action === "none") return;

    if (action === "Delete Item") {
      updatedItems = updatedItems.filter(i => i !== item);
    }

    if (action === "Make Active") {
      item.status = true;
    }

    if (action === "Make Inactive") {
      item.status = false;
    }
  });

  // Send updated items back to index.html
  if (window.opener) {
    window.opener.postMessage(
      {
        type: "RECONCILE_COMPLETE",
        items: updatedItems
      },
      "*"
    );
  }

  window.close();
}

</script>

</body>
</html>
